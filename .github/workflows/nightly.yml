name: Nightly Tests

on:
  schedule:
    - cron: '0 2 * * *'  # Run daily at 2 AM UTC
  workflow_dispatch:  # Allow manual triggering

jobs:
  nightly-tests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-dev.txt
    
    - name: Run full test suite
      run: |
        pytest tests/ -v --cov=. --cov-report=xml --cov-report=html --cov-report=term
    
    - name: Run all linters
      run: |
        flake8 . --count --statistics
        black --check .
        isort --check-only .
        pylint endpoints/ services/ models/ utils/ main.py || true
    
    - name: Security scan
      run: |
        bandit -r . -ll
        safety check
    
    - name: Upload coverage report
      uses: codecov/codecov-action@v5
      with:
        file: ./coverage.xml
        flags: nightly
        name: nightly-coverage


