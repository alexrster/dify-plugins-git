name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Check for Dify CLI
      id: check_dify
      run: |
        if command -v dify &> /dev/null; then
          echo "dify_available=true" >> $GITHUB_OUTPUT
          echo "✅ Dify CLI is available"
          dify --version || echo "Could not get version"
        else
          echo "dify_available=false" >> $GITHUB_OUTPUT
          echo "⚠️ Dify CLI not found, will use manual packaging (zip)"
        fi
    
    - name: Get version
      id: version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION=${GITHUB_REF#refs/tags/}
        fi
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "Version: ${VERSION}"
    
    - name: Update manifest version
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        # Remove 'v' prefix if present
        VERSION_NUMBER=${VERSION#v}
        # Update manifest.yaml
        if [[ "$OSTYPE" == "darwin"* ]]; then
          sed -i '' "s/version: .*/version: ${VERSION_NUMBER}/" manifest.yaml
        else
          sed -i "s/version: .*/version: ${VERSION_NUMBER}/" manifest.yaml
        fi
    
    - name: Package plugin
      id: package
      run: |
        mkdir -p dist
        VERSION="${{ steps.version.outputs.version }}"
        PACKAGE_NAME="git-integration-plugin-${VERSION}"
        PACKAGE_FILE="dist/${PACKAGE_NAME}.difypkg"
        
        if command -v dify &> /dev/null; then
          echo "Using Dify CLI to package plugin"
          dify plugin package . -o "${PACKAGE_FILE}"
        else
          echo "Dify CLI not available, creating .difypkg file manually (zip format)"
          # Create a zip file with .difypkg extension (difypkg is essentially a zip file)
          # Create .difypkg file (which is a zip file) manually
          if command -v zip &> /dev/null; then
            echo "Using zip command"
            zip -r "${PACKAGE_FILE}" \
              manifest.yaml \
              main.py \
              endpoints/ \
              services/ \
              models/ \
              utils/ \
              _assets/ \
              requirements.txt \
              -x "*.pyc" "*/__pycache__/*" "*/.git/*" "*/.pytest_cache/*" "*/tests/*" "*/.github/*" "*/dist/*" "*/build/*" "*.egg-info/*" "*.log" ".env" "*.private.pem" "*.public.pem"
          else
            echo "zip command not available, using Python"
            python3 << EOF
import zipfile
import os
from pathlib import Path
import sys

PACKAGE_FILE = "${PACKAGE_FILE}"
excludes = {'.git', 'tests', '.github', 'dist', 'build', '__pycache__', '.pytest_cache', '.env'}
files_to_include = [
    'manifest.yaml', 'main.py', 'requirements.txt',
    'endpoints', 'services', 'models', 'utils', '_assets'
]

with zipfile.ZipFile(PACKAGE_FILE, 'w', zipfile.ZIP_DEFLATED) as zf:
    for item in files_to_include:
        path = Path(item)
        if path.is_file():
            zf.write(path)
        elif path.is_dir():
            for root, dirs, files in os.walk(path):
                dirs[:] = [d for d in dirs if d not in excludes and not d.startswith('.')]
                for file in files:
                    if not any(file.endswith(ext) for ext in ['.pyc', '.log', '.pem', '.egg-info']):
                        file_path = Path(root) / file
                        zf.write(file_path)
print(f'Package created: {PACKAGE_FILE}')
EOF
          fi
        fi
        
        echo "package_file=${PACKAGE_FILE}" >> $GITHUB_OUTPUT
        echo "Package created: ${PACKAGE_FILE}"
        ls -lh dist/
    
    - name: Verify package
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        PACKAGE_FILE="dist/git-integration-plugin-${VERSION}.difypkg"
        
        echo "Checking for package file: ${PACKAGE_FILE}"
        echo "Contents of dist/ directory:"
        ls -lah dist/ || echo "dist/ directory does not exist"
        
        if [ -f "${PACKAGE_FILE}" ]; then
          echo "✅ Package file found: ${PACKAGE_FILE}"
          file "${PACKAGE_FILE}" || echo "file command not available"
          
          # Check file size (should be > 0)
          if command -v stat &> /dev/null; then
            SIZE=$(stat -f%z "${PACKAGE_FILE}" 2>/dev/null || stat -c%s "${PACKAGE_FILE}" 2>/dev/null)
            if [ "${SIZE}" -gt 0 ]; then
              echo "✅ Package size: ${SIZE} bytes"
            else
              echo "❌ Package file is empty"
              exit 1
            fi
          else
            # Fallback: use ls to check size
            LS_OUTPUT=$(ls -lh "${PACKAGE_FILE}" 2>/dev/null)
            if [ -n "${LS_OUTPUT}" ]; then
              echo "✅ Package file exists: ${LS_OUTPUT}"
            else
              echo "❌ Could not verify package file"
              exit 1
            fi
          fi
        else
          echo "❌ Package file not found: ${PACKAGE_FILE}"
          echo "Available files in dist/:"
          find dist/ -type f 2>/dev/null || echo "No files found"
          exit 1
        fi
    
    - name: Generate changelog
      id: changelog
      uses: metcalfc/changelog-generator@v4
      with:
        myToken: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/*.difypkg
          dist/*.tar.gz
        name: Release ${{ steps.version.outputs.version }}
        body: |
          ## Changes in ${{ steps.version.outputs.version }}
          
          ${{ steps.changelog.outputs.changelog }}
          
          ## Installation
          
          1. Download the `.difypkg` file
          2. Upload it to your Dify instance through the plugin management interface
          3. Activate the plugin and configure it
        draft: false
        prerelease: ${{ contains(steps.version.outputs.version, 'alpha') || contains(steps.version.outputs.version, 'beta') || contains(steps.version.outputs.version, 'rc') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


